// /firestore.rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // â”€â”€ helper í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ìš´ì˜ì ì—¬ë¶€: email ê¸°ë°˜ ëŒ€ì‹  ì»¤ìŠ¤í…€ í´ë ˆì„ì´ë‚˜ íŠ¹ì • UIDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
    function isAdmin() {
      return request.auth != null
          && request.auth.token.email == 'a@a.com';
    }
    // ì°¸ê°€ì ì—¬ë¶€: ìµëª… í¬í•¨, ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ true
    function isParticipant() {
      return request.auth != null;
    }

    // ğŸ†• ë³´ì¡° í•¨ìˆ˜: ë³¸ì¸ ë¬¸ì„œ ì—¬ë¶€
    function isSelf(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // ğŸ†• ë³´ì¡° í•¨ìˆ˜: ì´ë²¤íŠ¸ ë©¤ë²„ì‹­(ì„ íƒ)
    //    /events/{eventId}/memberships/{uid} ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ ê²€ì‚¬
    function isEventMember(eventId) {
      return request.auth != null
        && exists(/databases/$(database)/documents/events/$(eventId)/memberships/$(request.auth.uid));
    }

    // â”€â”€ ì´ë²¤íŠ¸ ì»¬ë ‰ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /events/{eventId} {
      // ìš´ì˜ìë§Œ ëŒ€íšŒ ìƒì„± ê°€ëŠ¥
      allow create: if isAdmin();

      // ğŸ†• í”Œë ˆì´ì–´ ê³µê°œ ëª©ë¡/ì ‘ì†ìš©: ì´ë²¤íŠ¸ ë¬¸ì„œëŠ” ë¡œê·¸ì¸ ì—†ì´ ì½ê¸° í—ˆìš©(get/list)
      //    â€» ì„œë¸Œì»¬ë ‰ì…˜(participants/rooms ë“±)ì€ ì•„ë˜ ê·œì¹™ëŒ€ë¡œ ì—¬ì „íˆ ì¸ì¦ í•„ìš”
      allow get, list: if true; // ğŸ†•

      // ìš´ì˜ìëŠ” ì „ì²´ ì½ê¸°Â·ì“°ê¸°Â·ì‚­ì œ
      allow read, update, delete: if isAdmin();

      // ì°¸ê°€ìëŠ” ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ ëŒ€íšŒ ê¸°ë³¸ ì •ë³´ ì½ê¸°Â·ìˆ˜ì •(ì˜ˆ: ì¸ì¦ ê²°ê³¼ ê¸°ë¡) í—ˆìš©
      allow read, update: if isParticipant();

      // â”€â”€ ì°¸ê°€ì ì„œë¸Œì»¬ë ‰ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      match /participants/{pid} {
        // ìš´ì˜ìëŠ” ì–¸ì œë‚˜ ììœ ë¡­ê²Œ
        allow read, write: if isAdmin();
        // ì°¸ê°€ìëŠ” ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ ìì‹ ì˜ ë°ì´í„° ì½ê¸°Â·ì“°ê¸° ê°€ëŠ¥
        allow read, write: if isParticipant();
      }

      // â”€â”€ ë°© ì •ë³´ ì„œë¸Œì»¬ë ‰ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      match /rooms/{roomId} {
        // ìš´ì˜ìëŠ” ììœ ë¡­ê²Œ
        allow read, write: if isAdmin();
        // ì°¸ê°€ìëŠ” ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ ë°© ì¡°íšŒÂ·ë°°ì •(update) í—ˆìš©
        allow read, update: if isParticipant();
      }

      // â”€â”€ í¬ë³¼ ë°© ì •ë³´ ì„œë¸Œì»¬ë ‰ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      match /fourballRooms/{roomId} {
        // ìš´ì˜ìëŠ” ììœ ë¡­ê²Œ
        allow read, write: if isAdmin();
        // ì°¸ê°€ìëŠ” ë¡œê·¸ì¸ë§Œ ë˜ì–´ ìˆìœ¼ë©´ íŒ€ ì¡°íšŒÂ·ë°°ì •(update) í—ˆìš©
        allow read, update: if isParticipant();
      }

      // ğŸ†• (ì„ íƒ) ì´ë²¤íŠ¸ ë©¤ë²„ì‹­ ì»¬ë ‰ì…˜: íšŒì›ì œ ì´ë²¤íŠ¸ ìš´ì˜ ì‹œ ì‚¬ìš©
      //    - ì½ê¸°: ë³¸ì¸/ê´€ë¦¬ì
      //    - ìƒì„±/ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      //    - ì‚­ì œ: ê´€ë¦¬ì
      match /memberships/{uid} {
        allow read: if isAdmin() || isSelf(uid);
        allow create: if isAdmin() || isSelf(uid);
        allow update: if isAdmin() || isSelf(uid);
        allow delete: if isAdmin();
      }
    }

    // ğŸ†• ìœ ì € í”„ë¡œí•„ ì»¬ë ‰ì…˜: ì´ë©”ì¼/ë¹„ë²ˆ ë¡œê·¸ì¸(íšŒì›ì œ) ë„ì… ì‹œ í”„ë¡œí•„ ì €ì¥ ìš©ë„
    //    - ì½ê¸°: ë³¸ì¸/ê´€ë¦¬ì
    //    - ìƒì„±: ë³¸ì¸
    //    - ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
    //    - ì‚­ì œ: ê´€ë¦¬ì
    match /users/{uid} {
      allow read: if isAdmin() || isSelf(uid);
      allow create: if isSelf(uid);                // [NOTE] íšŒì›ê°€ì… ì§í›„ cred.user.uid ê¸°ì¤€ìœ¼ë¡œ í—ˆìš©
      allow update: if isSelf(uid) || isAdmin();
      allow delete: if isAdmin();
    }

    // â”€â”€ ê·¸ ì™¸ ëª¨ë“  ê²½ë¡œ ê¸ˆì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
